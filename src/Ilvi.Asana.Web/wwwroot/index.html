<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asana Sync Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîÑ</text></svg>">
    <style>
        [x-cloak] { display: none !important; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 min-h-screen text-white">
    <div x-data="dashboard()" x-init="init()" x-cloak class="container mx-auto px-4 py-8 max-w-6xl">
        
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-4">
                <div class="text-4xl">üîÑ</div>
                <div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                        Asana Sync
                    </h1>
                    <p class="text-slate-400 text-sm">Asana verilerinizi senkronize edin</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <a href="/hangfire" target="_blank" 
                   class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition flex items-center gap-2">
                    üìä Hangfire
                </a>
                <a href="/swagger" target="_blank"
                   class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition flex items-center gap-2">
                    üìö API Docs
                </a>
            </div>
        </div>

        <!-- Status Card -->
        <div class="bg-slate-800/50 backdrop-blur rounded-2xl p-6 mb-6 border border-slate-700">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <div :class="status.isRunning ? 'bg-yellow-500 animate-pulse' : 'bg-green-500'" 
                             class="w-3 h-3 rounded-full"></div>
                        <span class="text-lg font-medium" x-text="status.isRunning ? '‚è≥ Sync √áalƒ±≈üƒ±yor...' : '‚úÖ Hazƒ±r'"></span>
                    </div>
                    <p class="text-slate-400 text-sm">
                        Son sync: <span x-text="status.lastSyncAt ? formatDate(status.lastSyncAt) : 'Hen√ºz yapƒ±lmadƒ±'"></span>
                        <template x-if="status.lastSyncDurationSeconds">
                            <span class="text-slate-500">(<span x-text="status.lastSyncDurationSeconds"></span>s)</span>
                        </template>
                    </p>
                </div>
                <div class="flex gap-3">
                    <button @click="startSync()" 
                            :disabled="status.isRunning"
                            :class="status.isRunning ? 'bg-slate-600 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-500'"
                            class="px-6 py-3 rounded-xl font-medium transition flex items-center gap-2">
                        <span x-show="!status.isRunning">üöÄ Sync Ba≈ülat</span>
                        <span x-show="status.isRunning" class="flex items-center gap-2">
                            <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            √áalƒ±≈üƒ±yor...
                        </span>
                    </button>
                    <button x-show="status.isRunning" 
                            @click="cancelSync()"
                            class="px-6 py-3 bg-red-600 hover:bg-red-500 rounded-xl font-medium transition">
                        üõë ƒ∞ptal
                    </button>
                </div>
            </div>

            <!-- Progress (when running) -->
            <template x-if="status.isRunning && status.currentProgress">
                <div class="mt-6 pt-6 border-t border-slate-700">
                    <h3 class="text-sm font-medium text-slate-400 mb-3">ƒ∞lerleme</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-slate-700/50 rounded-lg p-3">
                            <div class="text-2xl font-bold text-blue-400" x-text="status.currentProgress.usersCount">0</div>
                            <div class="text-xs text-slate-400">Users</div>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-3">
                            <div class="text-2xl font-bold text-green-400" x-text="status.currentProgress.projectsCount">0</div>
                            <div class="text-xs text-slate-400">Projects</div>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-3">
                            <div class="text-2xl font-bold text-purple-400" x-text="status.currentProgress.tasksCount">0</div>
                            <div class="text-xs text-slate-400">Tasks</div>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-3">
                            <div class="text-2xl font-bold text-orange-400" x-text="status.currentProgress.apiCallsCount">0</div>
                            <div class="text-xs text-slate-400">API Calls</div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
            <div class="bg-slate-800/50 backdrop-blur rounded-xl p-4 border border-slate-700">
                <div class="text-3xl font-bold text-blue-400" x-text="stats.usersCount">-</div>
                <div class="text-slate-400 text-sm">Users</div>
            </div>
            <div class="bg-slate-800/50 backdrop-blur rounded-xl p-4 border border-slate-700">
                <div class="text-3xl font-bold text-cyan-400" x-text="stats.workspacesCount">-</div>
                <div class="text-slate-400 text-sm">Workspaces</div>
            </div>
            <div class="bg-slate-800/50 backdrop-blur rounded-xl p-4 border border-slate-700">
                <div class="text-3xl font-bold text-green-400" x-text="stats.projectsCount">-</div>
                <div class="text-slate-400 text-sm">Projects</div>
            </div>
            <div class="bg-slate-800/50 backdrop-blur rounded-xl p-4 border border-slate-700">
                <div class="text-3xl font-bold text-purple-400" x-text="stats.tasksCount">-</div>
                <div class="text-slate-400 text-sm">Tasks</div>
            </div>
            <div class="bg-slate-800/50 backdrop-blur rounded-xl p-4 border border-slate-700">
                <div class="text-3xl font-bold text-yellow-400" x-text="stats.storiesCount">-</div>
                <div class="text-slate-400 text-sm">Stories</div>
            </div>
            <div class="bg-slate-800/50 backdrop-blur rounded-xl p-4 border border-slate-700">
                <div class="text-3xl font-bold text-orange-400" x-text="stats.attachmentsCount">-</div>
                <div class="text-slate-400 text-sm">Attachments</div>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div class="grid md:grid-cols-2 gap-6">
            
            <!-- Configuration -->
            <div class="bg-slate-800/50 backdrop-blur rounded-2xl p-6 border border-slate-700">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    ‚öôÔ∏è Ayarlar
                </h2>
                
                <div class="space-y-4">
                    <!-- Auto Sync Toggle -->
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium">Otomatik Sync</div>
                            <div class="text-sm text-slate-400">Zamanlanmƒ±≈ü senkronizasyon</div>
                        </div>
                        <button @click="config.isEnabled = !config.isEnabled; saveConfig()"
                                :class="config.isEnabled ? 'bg-green-600' : 'bg-slate-600'"
                                class="relative w-14 h-7 rounded-full transition-colors">
                            <div :class="config.isEnabled ? 'translate-x-7' : 'translate-x-1'"
                                 class="absolute top-1 w-5 h-5 bg-white rounded-full transition-transform"></div>
                        </button>
                    </div>

                    <!-- Schedule -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Senkronizasyon Sƒ±klƒ±ƒüƒ±</label>
                        <select x-model="config.cronExpression" @change="saveConfig()"
                                class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <template x-for="preset in cronPresets" :key="preset.value">
                                <option :value="preset.value" x-text="preset.label"></option>
                            </template>
                        </select>
                    </div>

                    <!-- Download Attachments -->
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium">Attachment ƒ∞ndir</div>
                            <div class="text-sm text-slate-400">Dosyalarƒ± yerel olarak sakla</div>
                        </div>
                        <button @click="config.downloadAttachments = !config.downloadAttachments; saveConfig()"
                                :class="config.downloadAttachments ? 'bg-green-600' : 'bg-slate-600'"
                                class="relative w-14 h-7 rounded-full transition-colors">
                            <div :class="config.downloadAttachments ? 'translate-x-7' : 'translate-x-1'"
                                 class="absolute top-1 w-5 h-5 bg-white rounded-full transition-transform"></div>
                        </button>
                    </div>

                    <!-- Thumbnails -->
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium">Thumbnail Olu≈ütur</div>
                            <div class="text-sm text-slate-400">K√º√ß√ºk √∂nizleme resimleri</div>
                        </div>
                        <button @click="config.generateThumbnails = !config.generateThumbnails; saveConfig()"
                                :class="config.generateThumbnails ? 'bg-green-600' : 'bg-slate-600'"
                                class="relative w-14 h-7 rounded-full transition-colors">
                            <div :class="config.generateThumbnails ? 'translate-x-7' : 'translate-x-1'"
                                 class="absolute top-1 w-5 h-5 bg-white rounded-full transition-transform"></div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent Logs -->
            <div class="bg-slate-800/50 backdrop-blur rounded-2xl p-6 border border-slate-700">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    üìã Son Senkronizasyonlar
                </h2>
                
                <div class="space-y-2 max-h-80 overflow-y-auto">
                    <template x-for="log in logs" :key="log.id">
                        <div class="bg-slate-700/50 rounded-lg p-3 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div :class="{
                                    'bg-green-500': log.status === 'Completed',
                                    'bg-red-500': log.status === 'Failed',
                                    'bg-yellow-500 animate-pulse': log.status === 'Running',
                                    'bg-slate-500': log.status === 'Cancelled'
                                }" class="w-2 h-2 rounded-full"></div>
                                <div>
                                    <div class="text-sm" x-text="formatDate(log.startedAt)"></div>
                                    <div class="text-xs text-slate-400">
                                        <span x-text="log.tasksCount"></span> tasks,
                                        <span x-text="log.projectsCount"></span> projects
                                        <template x-if="log.durationSeconds">
                                            <span class="text-slate-500">‚Ä¢ <span x-text="log.durationSeconds"></span>s</span>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            <span :class="{
                                'text-green-400': log.status === 'Completed',
                                'text-red-400': log.status === 'Failed',
                                'text-yellow-400': log.status === 'Running',
                                'text-slate-400': log.status === 'Cancelled'
                            }" class="text-xs font-medium" x-text="log.status"></span>
                        </div>
                    </template>
                    <template x-if="logs.length === 0">
                        <div class="text-center text-slate-400 py-8">
                            Hen√ºz senkronizasyon yapƒ±lmadƒ±
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-slate-500 text-sm">
            Asana Sync v2.0 ‚Ä¢ 
            <a href="https://github.com" class="hover:text-slate-400">GitHub</a>
        </div>
    </div>

    <script>
        function dashboard() {
            return {
                status: {
                    isRunning: false,
                    lastSyncAt: null,
                    lastSyncStatus: null,
                    lastSyncDurationSeconds: null,
                    currentProgress: null
                },
                stats: {
                    usersCount: 0,
                    workspacesCount: 0,
                    projectsCount: 0,
                    tasksCount: 0,
                    storiesCount: 0,
                    attachmentsCount: 0
                },
                config: {
                    cronExpression: '0 */3 * * *',
                    isEnabled: true,
                    downloadAttachments: true,
                    generateThumbnails: true,
                    thumbnailMaxWidth: 400,
                    attachmentBasePath: './attachments'
                },
                cronPresets: [],
                logs: [],

                async init() {
                    await Promise.all([
                        this.loadStatus(),
                        this.loadStats(),
                        this.loadConfig(),
                        this.loadCronPresets(),
                        this.loadLogs()
                    ]);

                    // Poll for updates
                    setInterval(() => {
                        this.loadStatus();
                        if (this.status.isRunning) {
                            this.loadStats();
                        }
                    }, 2000);

                    setInterval(() => this.loadLogs(), 10000);
                },

                async loadStatus() {
                    try {
                        const res = await fetch('/api/sync/status');
                        this.status = await res.json();
                    } catch (e) {
                        console.error('Status load error:', e);
                    }
                },

                async loadStats() {
                    try {
                        const res = await fetch('/api/sync/stats');
                        this.stats = await res.json();
                    } catch (e) {
                        console.error('Stats load error:', e);
                    }
                },

                async loadConfig() {
                    try {
                        const res = await fetch('/api/configuration');
                        this.config = await res.json();
                    } catch (e) {
                        console.error('Config load error:', e);
                    }
                },

                async loadCronPresets() {
                    try {
                        const res = await fetch('/api/configuration/cron-presets');
                        this.cronPresets = await res.json();
                    } catch (e) {
                        console.error('Cron presets load error:', e);
                    }
                },

                async loadLogs() {
                    try {
                        const res = await fetch('/api/sync/logs?limit=10');
                        this.logs = await res.json();
                    } catch (e) {
                        console.error('Logs load error:', e);
                    }
                },

                async saveConfig() {
                    try {
                        await fetch('/api/configuration', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.config)
                        });
                    } catch (e) {
                        console.error('Config save error:', e);
                    }
                },

                async startSync() {
                    try {
                        await fetch('/api/sync/start', { method: 'POST' });
                        await this.loadStatus();
                        await this.loadLogs();
                    } catch (e) {
                        console.error('Start sync error:', e);
                    }
                },

                async cancelSync() {
                    try {
                        await fetch('/api/sync/cancel', { method: 'POST' });
                        await this.loadStatus();
                    } catch (e) {
                        console.error('Cancel sync error:', e);
                    }
                },

                formatDate(dateStr) {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return date.toLocaleString('tr-TR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            };
        }
    </script>
</body>
</html>
